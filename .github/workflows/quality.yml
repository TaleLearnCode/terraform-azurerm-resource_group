name: Quality

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy

  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog Secret Scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --only-verified

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify README.md exists
        run: |
          if [ ! -f README.md ]; then
            echo "âŒ README.md not found"
            exit 1
          fi
          echo "âœ… README.md exists"

      - name: Verify CONTRIBUTING.md exists
        run: |
          if [ ! -f CONTRIBUTING.md ]; then
            echo "âš ï¸  CONTRIBUTING.md not found (optional)"
          else
            echo "âœ… CONTRIBUTING.md exists"
          fi

      - name: Check README content
        run: |
          if ! grep -q "## Usage" README.md && ! grep -q "## Installation" README.md; then
            echo "âš ï¸  README.md should contain usage or installation section"
          else
            echo "âœ… README.md has required sections"
          fi

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Terraform Version Constraints
        run: |
          echo "Checking terraform version requirements..."
          
          if grep -r "required_version" . --include="*.tf" | grep -q "1.9"; then
            echo "âœ… Terraform version constraint specifies 1.9+"
          else
            echo "âš ï¸  Recommend specifying Terraform >= 1.9 for AVM compatibility"
          fi

      - name: Check Provider Versions
        run: |
          echo "Checking provider version constraints..."
          
          if grep -r "azurerm" . --include="*.tf" | grep -q "~>"; then
            echo "âœ… Provider versions use constraint operators"
          else
            echo "âš ï¸  Recommend using constraint operators (e.g., ~>) for provider versions"
          fi

      - name: Create Quality Report
        run: |
          echo "## ðŸ“Š Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Scans" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trivy vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TruffleHog secret detection completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… README.md verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform and provider versions checked" >> $GITHUB_STEP_SUMMARY
